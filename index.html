<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="https://jerkwin.github.io/jscss/pmd.min.css">
        <script type="text/javascript" src="https://jerkwin.github.io/jscss/ChemDoodleWeb.js"></script>
        <title>分子可视化</title>
    </head>

    <script>
        // 页面加载完毕时执行
        window.onload = function() {
            setTimeout(function() {
                document.getElementById('getcoords').click(); 
            }, 100); 
        };
    </script>
    
    <div class="wrap">
    <table>
        <tr>
            <td>
                <input type="button" id="getcoords" value="获取坐标" onClick="getcoords()" style="font-size:1em;font-weight:bold;color:red;width:100%; height:30px" />
            </td>
            <td>
                <input type="button" value="显示分子" onClick="setcoords()" style="font-size:1em;font-weight:bold;color:red;width:100%; height:30px" />
            </td>
        </tr>

        <tr>
            <td>
                <textarea id="textarea" style="width: 400px; height: 400px; resize: none;"></textarea>
            </td>

            <td>
                <script>
                    var Mol = new ChemDoodle.TransformCanvas3D('Mol-1', 400, 400);
                    Mol.specs.backgroundColor='#000000';
                    Mol.specs.set3DRepresentation('Ball and Stick');
                    Mol.specs.projectionPerspective_3D = false;
                    Mol.specs.compass_display=true; // 坐标轴显示
                    Mol.specs.atoms_displayLabels_3D=false; // 原子标签显示
                    Mol.specs.bonds_splitColor = true;
                    Mol.specs.text_font_stroke_3D = true;
                    Mol.specs.bonds_cylinderDiameter_3D = 0.3; //键粗细
                    // 动画设置
                    Mol.handle = null;
                    Mol.timeout = 15;
                    Mol.startAnimation = ChemDoodle._AnimatorCanvas.prototype.startAnimation;
                    Mol.stopAnimation = ChemDoodle._AnimatorCanvas.prototype.stopAnimation;
                    Mol.isRunning = ChemDoodle._AnimatorCanvas.prototype.isRunning;
                    Mol.dblclick = ChemDoodle.RotatorCanvas.prototype.dblclick;
                    Mol.nextFrame = function(delta){
                        var matrix = [];
                        ChemDoodle.lib.mat4.identity(matrix);
                        var change = delta*Math.PI/15000;
                        ChemDoodle.lib.mat4.rotate(matrix, change, [ 1, 0, 0 ]);
                        ChemDoodle.lib.mat4.rotate(matrix, change, [ 0, 1, 0 ]);
                        ChemDoodle.lib.mat4.rotate(matrix, change, [ 0, 0, 1 ]);
                        ChemDoodle.lib.mat4.multiply(this.rotationMatrix, matrix)
                    };
                    ChemDoodle.io.file.content('https://raw.githubusercontent.com/liuyujie714/chemjs/main/mol/ch4.xyz', function(fileContent) {
                        let mol = ChemDoodle.readXYZ(ltrim(fileContent));
                        Mol.loadMolecule(mol)
                    });
                    Mol.startAnimation() // 开始动画
        
                    var $ = function(id) { return document.getElementById(id); }
                    function setview(id)
                    {   
                        switch(id)
                        {
                            case 'Line':
                                Mol.specs.set3DRepresentation('Line');
                                break;
                            case 'Stick':
                                Mol.specs.set3DRepresentation('Stick');
                                break;
                            case 'Wireframe':
                                Mol.specs.set3DRepresentation('Wireframe');
                                break;
                            case 'vdW':
                                Mol.specs.set3DRepresentation('van der Waals Spheres');
                                break;
                            case 'CPK':
                                Mol.specs.set3DRepresentation('Ball and Stick');
                                break;
                        }
                        Mol.repaint()
                    }

                    function printf()
                    {
                        var a={s:function(a,b){return b*=1,m=Array(Math.max(Math.abs(b)-a.length+1,0)).join(" "),b>0?m+a:a+m},f:function(a,b){return b=b.split("."),a=parseFloat(a).toFixed(b[1]),m=Array(Math.max(Math.abs(b[0])-a.length+1,0)).join(" "),b[0]>0?m+a:a+m}},b=Array.prototype.slice.call(arguments).slice();return b.shift().toString().replace(/%(-*\d*\.*\d*)([sf])/g,function(c,d,e){if(!b.length)throw new Error("Too few elements");return a[e](b.shift(),d)})
                    }
        
                    function getcoords()
                    {
                       // 第一个分子
                       let atoms = Mol.molecules[0].atoms
                       let s = atoms.length+"\nMOL\n"
                       atoms.forEach(e => {
                            s += printf("%5s", e.label)+printf("%12.6f", e.x)+printf("%12.6f", e.y)+printf("%12.6f", e.z)+"\n"
                       });
                       $("textarea").value = s
                    }

                    // remove multi started spaces and add '\n'
                    function ltrim(s)
                    {
                        return s.split('\n').map(line=>line.trimStart()).join('\n')
                    }

                    function setcoords()
                    {
                        try {
                            let xyz = ChemDoodle.readXYZ(ltrim($("textarea").value))
                            Mol.loadMolecule(xyz)
                        }
                        catch {
                            alert("坐标输入格式错误, 必须是XYZ")
                            return
                        }
                    }

                    function showlabel()
                    {
                        Mol.specs.atoms_displayLabels_3D=$("label").checked;
                        Mol.repaint()
                    }
                </script>

                <div> 
                    <input type="checkbox" id="label" onChange="showlabel()" /> Label
                    <input type="radio" name="style" id='CPK' checked="checked" onChange="setview(id)" /> CPK
                    <input type="radio" name="style" id='Line' onChange="setview(id)" /> Line
                    <input type="radio" name="style" id='vdW' onChange="setview(id)" /> vdW
                    <input type="radio" name="style" id='Stick' onChange="setview(id)" /> Stick
                    <input type="radio" name="style" id='Wireframe' onChange="setview(id)" /> Wire
                </div>

            </td>
        </tr>

    </table>
    </div>
    
</html>

